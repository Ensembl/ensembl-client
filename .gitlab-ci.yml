# CICD - Reload with missing static images
stages:
  - test_build_static
  - build_docker_images
  - deploy

variables:
  CONTAINER_IMAGE: $GITLAB_REGISTRY_URL/$GITLAB_REGISTRY_NAMESPACE/ensembl-client:${CI_COMMIT_SHORT_SHA}
  KUBECONFIG: /etc/deploy/config

Test & Build:
  image: node:10.15.1
  stage: test_build_static

#  variables:
#    NODE_ENV: "production"
#    API_HOST: "//ec2-18-234-147-183.compute-1.amazonaws.com"

  before_script:
  - ls
  - cd src/ensembl
  - echo "In the src/ensembl directory"
  - ls
  - npm ci

  script:
  - npm run test
  - export NODE_ENV=production
  - export API_HOST=''
  - npm run build

  only:
  - cicd-test

  artifacts:
    name: static_assets
    paths:
    - src/ensembl/dist/

  only:
  - cicd-test

Nginx:
  image: docker
  
  services:
    - docker:dind
  
  stage: build_docker_images

  script:
  - apk update && apk add git
  - git clone --depth 1 https://github.com/Ensembl/ensembl-2020-static-assests.git
  - git clone --depth 1 https://gitlab.ebi.ac.uk/kamal/ensembl-client-nginx.git
  - ls ensembl-client-nginx/
  - docker build -t ${CONTAINER_IMAGE} -f ensembl-client-nginx/Dockerfile --no-cache .
  - docker images
  - echo "$GITLAB_REGISTRY_TOKEN" | docker login -u "$GITLAB_REGISTRY_USER" --password-stdin https://"$GITLAB_REGISTRY_URL"
  - docker push ${CONTAINER_IMAGE}
  - docker rmi ${CONTAINER_IMAGE}
  - docker logout "$GITLAB_REGISTRY_URL"

  only:
  - cicd-test

Staging:
  stage: deploy
  image: alpine
  only:
  - cicd-test
  before_script:
  - mkdir -p /etc/deploy
  - echo ${EMBASSY_KUBECONFIG} | base64 -d > ${KUBECONFIG}
  script:
  - apk update && apk add --no-cache curl git
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  - chmod +x ./kubectl
  - mv ./kubectl /usr/local/bin/kubectl
  - git clone https://gitlab.ebi.ac.uk/kamal/ensembl-client-caas-deploy.git
  - cd ensembl-client-caas-deploy
  - git checkout refactor-manifest
  - cd ..
  - sed -i "s/<VERSION>/${CI_COMMIT_SHORT_SHA}/g" ensembl-client-caas-deploy/ensembl_client_deployment.yaml
  - sed -i "s/<DEPLOYMNET_ENV>/staging/g" ensembl-client-caas-deploy/ensembl_client_deployment.yaml
  - cat ensembl-client-caas-deploy/ensembl_client_deployment.yaml
  - kubectl config view
  - kubectl config use-context ens-stage-ctx
  #- kubectl apply -f ensembl-client-caas-deploy/ensembl_client_service_node.yaml
  - kubectl apply -f ensembl-client-caas-deploy/ensembl_client_deployment.yaml

#Live:
#  stage: deploy
#  image: alpine
#  only:
#  - cicd-test
#  before_script:
#  - mkdir -p /etc/deploy
#  - echo ${KUBE_CONFIG} | base64 -d > ${KUBECONFIG}
#  script:
#  - apk update && apk add --no-cache curl git
#  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
#  - chmod +x ./kubectl
#  - mv ./kubectl /usr/local/bin/kubectl
#  - git clone https://gitlab.ebi.ac.uk/kamal/ensembl-client-caas-deploy.git
#  - sed -i "s/<VERSION>/${CI_COMMIT_SHORT_SHA}/g" ensembl-client-caas-deploy/ett_cicd_test_deployment.yaml
#  - cat ensembl-client-caas-deploy/ett_cicd_test_deployment.yaml
#  - kubectl config view
#  - kubectl config use-context ucp_hh-ucp.caas.ebi.ac.uk:6443_kamal
#  - kubectl apply -f ensembl-client-caas-deploy/ett_cicd_test_service.yaml
#  - kubectl apply -f ensembl-client-caas-deploy/ett_cicd_test_deployment.yaml
#  when: manual
