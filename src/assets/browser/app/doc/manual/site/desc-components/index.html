<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Major Components - e2020 Browser App Field Manual</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Major Components";
    var mkdocs_page_input_path = "desc-components.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> e2020 Browser App Field Manual</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Description</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Major Components</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#major-components">Major Components</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#instrumentation">Instrumentation</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../desc-source/">Source Code Structure</a>
                </li>
                <li class="">
                    
    <a class="" href="../desc-build/">Build System</a>
                </li>
                <li class="">
                    
    <a class="" href="../desc-integration/">Integration</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Architecture Decision Records</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../arch/0001-webgl/">0001 Use WebGL</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/0002-wrap-webgl/">0002 Wrap WebGL</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/0003-use-wasm/">0003 Use WASM</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/0004-use-rust/">0004 Use Rust</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/0005-breakpoints/">0005 Scale breakpoints</a>
                </li>
                <li class="">
                    
    <a class="" href="../arch/0006-bytecode/">0006 Use a bytecode</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Standards</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../standard-rust/">Rust Coding Standards</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">e2020 Browser App Field Manual</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Description &raquo;</li>
        
      
    
    <li>Major Components</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="major-components">Major Components</h1>
<h2 id="instrumentation">Instrumentation</h2>
<p>Instrumentation code exists to assist development and debugging of the browser
app. It is generally not available in deployed builds to reduce file size and
improve performance.</p>
<h3 id="black-box">Black Box</h3>
<p>The black box system periodically sends logs and data sets to the backend
server. There, the server stores this data in filesi, according to server
configuration. The backend server also controls which datasets and logs are
captured, and the frequency of callbacks. These are controlled by a
configuration file. This file is sent to the client as the response to each
request containing data.</p>
<p>The primary use of the black box is to monitor performance.</p>
<p>Data sets are arranged into streams which are represented by a string. Each
log or data capture includes the stream to which it belongs. The server
configures which logs and data to capture and their destination file based on
the originating stream.</p>
<p>A stack allows a log message to be contextualised by pusing and popping string
context as to its location. This allows the same log messages to be divided
into subsets. The stack mechanism is relatively heavyweight and designed only
for debugging rather than long-lived instrumentation.</p>
<p>The blackbox supports abstract drivers. These use different mechanisms to
report to the server. Currently only an http driver and null driver are
implemented.</p>
<h4 id="important-files">Important Files</h4>
<ul>
<li><code>app/data/blackbox</code> -- contains rust files implementing the blackbox:<ul>
<li>core<ul>
<li><code>blackbox.rs</code> -- high-level static API for use in macros.</li>
<li><code>blackboxstate.rs</code> -- current state of blackbox on client.</li>
<li><code>bbreportstream.rs</code> -- implements a single stream's pending contents.</li>
</ul>
</li>
<li>drivers<ul>
<li><code>blackboxdriver.rs</code> -- facade around driver implementations.</li>
<li><code>httpblackboxdriver.rs</code> -- driver implementation for HTTP callbacks.</li>
<li><code>nullblackboxdriver.rs</code> -- no-op driver implementation.</li>
<li><code>stubdriver.rs</code> -- non-implementation of driver for production builds</li>
</ul>
</li>
</ul>
</li>
<li><code>macros.rs</code> -- macros to use blackbox in code.</li>
<li><code>debug_mode.yaml</code> -- server side configuration</li>
<li><code>POST /browser/debug</code> -- API endpoint</li>
</ul>
<h4 id="macros">Macros</h4>
<p>The blackbox is used exclusively through macros.</p>
<ul>
<li><code>bb_time(stream,block)</code> -- execute block, timing it and adding to stream dataset.</li>
<li><code>bb_metronome(stream)</code> -- add to dataset interval between each call to this macro for this stream</li>
<li><code>bb_log(stream,format,args)</code> -- write formatted log message to stream</li>
<li><code>bb_stack(string,block)</code> -- push "string" onto stack and execute block</li>
</ul>
<h4 id="payload-format-post-browserdebug">Payload Format (POST /browser/debug)</h4>
<h5 id="client-to-server-payload">Client to Server Payload</h5>
<p>POST request with raw JSON payload.</p>
<pre><code>{
  &quot;instance_id&quot;: &quot;&lt;string&gt;&quot;, /* browser-identifying string */
  &quot;streams&quot;: {
    &quot;&lt;stream-name&gt;&quot;: {
      &quot;reports&quot;: [
        {
          &quot;time&quot;: &lt;number&gt;,   /* ms since unix epoch */
          &quot;text&quot;: &quot;&lt;string&gt;&quot;, /* log contents */
          &quot;stack&quot;: &quot;&lt;string&gt;&quot; /* stack at time of logging  */
        },...
      ],
      &quot;dataset&quot;: [&lt;number&gt;,...] /* dataset. Key may be absent if not configured */
      }
    }, ...
  }
}
</code></pre>

<h5 id="server-to-client">Server to Client</h5>
<p>POST request response with raw JSON payload. The whole contents of
<code>debug_mode.yaml</code> are sent (ranscoded), though the server only reacts to some
keys.</p>
<pre><code>{
  &quot;enabled&quot;: [&quot;&lt;string&gt;&quot;,...], /* streams to enable */
  &quot;dataset&quot;: [&quot;&lt;string&gt;&quot;,...], /* datasets to enable (stream must also be enabled) */
  &quot;interval&quot;: &lt;number&gt;, /* requested interval (in seconds) between updates */
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../desc-source/" class="btn btn-neutral float-right" title="Source Code Structure">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../desc-source/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../fileurl.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
